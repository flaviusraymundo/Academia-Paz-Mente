openapi: 3.0.3
info:
  title: Academia Paz Mente Admin API
  version: "1.0.0"
servers:
  - url: /api

paths:
  /admin/courses/{courseId}/full:
    get:
      summary: Get full course tree (course + modules + items + quizzes + questions)
      parameters:
        - in: path
          name: courseId
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CourseFull"
        "400":
          $ref: "#/components/responses/BadRequest"
        "404":
          $ref: "#/components/responses/NotFound"

  /admin/courses/{courseId}/export:
    get:
      summary: Export course as round-trip JSON
      parameters:
        - in: path
          name: courseId
          required: true
          schema:
            type: string
            format: uuid
        - in: query
          name: dropIds
          schema:
            type: string
            enum: ["1"]
        - in: query
          name: blankMedia
          schema:
            type: string
            enum: ["1"]
        - in: query
          name: sanitize
          schema:
            type: string
            enum: ["1"]
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  export:
                    $ref: "#/components/schemas/CourseImportPayload"
                  dropIds:
                    type: boolean
                  blankMedia:
                    type: boolean
                  sanitize:
                    type: boolean
        "400":
          $ref: "#/components/responses/BadRequest"
        "404":
          $ref: "#/components/responses/NotFound"

  /admin/courses/{courseId}/duplicate:
    post:
      summary: Duplicate an existing course (server-side export+import)
      parameters:
        - in: path
          name: courseId
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                slug:
                  type: string
                title:
                  type: string
                blankMedia:
                  type: boolean
                sanitize:
                  type: boolean
                includeQuestions:
                  type: boolean
                  default: true
                active:
                  type: boolean
                  default: false
                simulate:
                  type: boolean
                  default: false
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                oneOf:
                  - type: object
                    properties:
                      simulate:
                        type: boolean
                      course:
                        $ref: "#/components/schemas/CourseSummary"
                      modules:
                        type: array
                        items:
                          $ref: "#/components/schemas/ModulePreview"
                  - type: object
                    properties:
                      ok:
                        type: boolean
                      course:
                        $ref: "#/components/schemas/CourseSummary"
                      modules:
                        type: array
                        items:
                          type: object
                          properties:
                            title:
                              type: string
                            order:
                              type: integer
                            itemCount:
                              type: integer
        "400":
          $ref: "#/components/responses/BadRequest"
        "409":
          $ref: "#/components/responses/Conflict"
        "500":
          $ref: "#/components/responses/ServerError"

  /admin/items/{itemId}/move:
    post:
      summary: Move item to target module or reorder within the same module
      parameters:
        - in: path
          name: itemId
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                targetModuleId:
                  type: string
                  format: uuid
                newOrder:
                  type: integer
                  minimum: 1
      responses:
        "200":
          description: OK
        "400":
          $ref: "#/components/responses/BadRequest"
        "404":
          $ref: "#/components/responses/NotFound"
        "409":
          $ref: "#/components/responses/Conflict"
        "500":
          $ref: "#/components/responses/ServerError"

  /admin/modules/{moduleId}/quiz-wizard:
    post:
      summary: Create a quiz for module and insert a quiz item
      parameters:
        - in: path
          name: moduleId
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                passScore:
                  type: integer
                  minimum: 0
                  maximum: 100
                  default: 70
                order:
                  type: integer
                  minimum: 1
      responses:
        "200":
          description: OK
        "400":
          $ref: "#/components/responses/BadRequest"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/ServerError"

  /admin/items/{itemId}/duplicate:
    post:
      summary: Duplicate an item (if quiz, reuse or create quiz in target module)
      parameters:
        - in: path
          name: itemId
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                targetModuleId:
                  type: string
                  format: uuid
                order:
                  type: integer
                  minimum: 1
                blankMedia:
                  type: boolean
      responses:
        "200":
          description: OK
        "400":
          $ref: "#/components/responses/BadRequest"
        "404":
          $ref: "#/components/responses/NotFound"
        "409":
          $ref: "#/components/responses/Conflict"
        "500":
          $ref: "#/components/responses/ServerError"

  /admin/modules/{moduleId}/duplicate:
    post:
      summary: Duplicate a module with its items and (optionally) quiz
      parameters:
        - in: path
          name: moduleId
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                targetCourseId:
                  type: string
                  format: uuid
                title:
                  type: string
                order:
                  type: integer
                  minimum: 1
                blankMedia:
                  type: boolean
      responses:
        "200":
          description: OK
        "400":
          $ref: "#/components/responses/BadRequest"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/ServerError"

  /admin/courses/import:
    post:
      summary: Import a course from JSON structure
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CourseImportPayloadWithFlags"
      responses:
        "200":
          description: OK
        "400":
          $ref: "#/components/responses/BadRequest"
        "409":
          $ref: "#/components/responses/Conflict"
        "500":
          $ref: "#/components/responses/ServerError"

  /quizzes/{quizId}:
    get:
      summary: Get quiz and its questions for the authenticated learner
      parameters:
        - in: path
          name: quizId
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  quiz:
                    type: object
                    properties:
                      id: { type: string, format: uuid }
                      moduleId: { type: string, format: uuid }
                      passScore: { type: integer }
                      questions:
                        type: array
                        items:
                          type: object
                          properties:
                            id: { type: string }
                            kind: { type: string }
                            body: { type: object, additionalProperties: true }
                            choices:
                              type: array
                              items: { type: object, additionalProperties: true }
        "400": { $ref: "#/components/responses/BadRequest" }
        "401": { $ref: "#/components/responses/BadRequest" }
        "403": { $ref: "#/components/responses/BadRequest" }
        "404": { $ref: "#/components/responses/NotFound" }
        "500": { $ref: "#/components/responses/ServerError" }

  /me/certificates/{courseId}/issue:
    post:
      summary: Issue a course certificate for the authenticated learner
      parameters:
        - in: path
          name: courseId
          required: true
          schema:
            type: string
            format: uuid
        - in: query
          name: reissue
          schema: { type: string, enum: ["1"] }
        - in: query
          name: keepIssuedAt
          schema: { type: string, enum: ["1"] }
        - in: query
          name: fullName
          schema: { type: string }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  id: { type: string }
                  user_id: { type: string }
                  course_id: { type: string }
                  issued_at: { type: string }
                  pdf_url: { type: string }
                  serial: { type: string, nullable: true }
                  hash: { type: string, nullable: true }
                  verifyUrl: { type: string, nullable: true }
        "400": { $ref: "#/components/responses/BadRequest" }
        "401": { $ref: "#/components/responses/BadRequest" }
        "403": { $ref: "#/components/responses/BadRequest" }
        "404": { $ref: "#/components/responses/NotFound" }
        "409": { $ref: "#/components/responses/Conflict" }
        "500": { $ref: "#/components/responses/ServerError" }

components:
  responses:
    BadRequest:
      description: Bad Request
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
    NotFound:
      description: Not Found
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
    Conflict:
      description: Conflict
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
    ServerError:
      description: Server Error
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"

  schemas:
    ErrorResponse:
      type: object
      properties:
        error:
          type: string
        detail:
          type: string

    PayloadRef:
      type: object
      additionalProperties: true
      description: Arbitrary object with optional media-related keys stripped when sanitize/blankMedia are enabled.

    CourseSummary:
      type: object
      properties:
        id:
          type: string
          format: uuid
        slug:
          type: string
        title:
          type: string
        summary:
          type: string
          nullable: true
        level:
          type: string
          nullable: true
        active:
          type: boolean
        draft:
          type: boolean

    ModulePreview:
      type: object
      properties:
        title:
          type: string
        order:
          type: integer
        items:
          type: array
          items:
            type: object
            properties:
              type:
                type: string
                enum: ["video","text","quiz"]
              order:
                type: integer
              payloadRef:
                $ref: "#/components/schemas/PayloadRef"
        quiz:
            type: object
            nullable: true
            properties:
              passScore:
                type: integer
              questions:
                type: array
                items:
                  type: object
                  properties:
                    kind:
                      type: string
                    body:
                      type: object
                      additionalProperties: true
                    choices:
                      type: array
                      items:
                        type: object
                        properties:
                          id:
                            type: string
                          text:
                            type: string
                    answerKey: {}

    CourseFull:
      type: object
      properties:
        course:
          $ref: "#/components/schemas/CourseSummary"
        modules:
          type: array
          items:
            type: object
            properties:
              id:
                type: string
                format: uuid
              title:
                type: string
              order:
                type: integer
              items:
                type: array
                items:
                  type: object
                  properties:
                    id:
                      type: string
                      format: uuid
                    type:
                      type: string
                      enum: ["video","text","quiz"]
                    order:
                      type: integer
                    payloadRef:
                      $ref: "#/components/schemas/PayloadRef"
              quiz:
                type: object
                nullable: true
                properties:
                  id:
                    type: string
                    format: uuid
                  passScore:
                    type: integer
                  questions:
                    type: array
                    items:
                      type: object
                      properties:
                        id:
                          type: string
                          format: uuid
                        kind:
                          type: string
                        body:
                          type: object
                          additionalProperties: true
                        choices:
                          type: array
                          items:
                            type: object
                            properties:
                              id:
                                type: string
                              text:
                                type: string
                        answerKey: {}

    CourseImportPayload:
      type: object
      properties:
        course:
          type: object
          properties:
            slug:
              type: string
            title:
              type: string
            summary:
              type: string
              nullable: true
            level:
              type: string
              nullable: true
            active:
              type: boolean
        modules:
          type: array
          items:
            type: object
            properties:
              title:
                type: string
              items:
                type: array
                items:
                  type: object
                  properties:
                    type:
                      type: string
                      enum: ["video","text","quiz"]
                    payloadRef:
                      $ref: "#/components/schemas/PayloadRef"
              quiz:
                type: object
                nullable: true
                properties:
                  passScore:
                    type: integer
                  questions:
                    type: array
                    items:
                      type: object
                      properties:
                        kind:
                          type: string
                        body:
                          type: object
                          additionalProperties: true
                        choices:
                          type: array
                          items:
                            type: object
                            properties:
                              id:
                                type: string
                              text:
                                type: string
                        answerKey: {}

    CourseImportPayloadWithFlags:
      allOf:
        - $ref: "#/components/schemas/CourseImportPayload"
        - type: object
          properties:
            simulate:
              type: boolean
            blankMedia:
              type: boolean
            sanitize:
              type: boolean

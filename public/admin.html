<!doctype html>
<html lang="pt-BR">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Admin Lite</title>
<style>
  body { font-family: system-ui, Arial, sans-serif; line-height: 1.35; margin: 16px; }
  h1, h2 { margin: 8px 0; }
  input, textarea, select, button { margin: 4px 0; padding: 6px 8px; }
  pre { background:#fafafa }
  .graph { display: grid; gap: 12px; margin-top: 8px; }
  .level { display: flex; gap: 12px; align-items: flex-start; }
  .node { border:1px solid #ddd; border-radius: 10px; padding:10px 12px; min-width: 220px; box-shadow: 0 1px 2px rgba(0,0,0,.05); }
  .node .title { font-weight: 600; margin-bottom: 6px; }
  .pill { display:inline-block; border-radius:999px; padding:2px 8px; font-size:12px; margin-right:6px; border:1px solid #eee }
  .ok { background:#e8f9ee; border-color:#bfe8cd; }
  .warn { background:#fff7e0; border-color:#ffe28a; }
  .bad { background:#ffeaea; border-color:#ffc3c3; }
  .muted { color:#666 }
  .legend { display:flex; gap:8px; margin-top:6px; flex-wrap: wrap; }
  .legend .pill { border: none }
  .code { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; background:#f6f6f6; padding:2px 6px; border-radius:6px }
</style>
<body>
  <h1>Admin Lite</h1>

  <section>
    <h2>Auth</h2>
    <p>Pegue um JWT (DEV_FAKE): <code>/.netlify/functions/dev-jwt?email=seu@email</code>
       e cole abaixo. Seu e-mail deve estar em <code>ADMIN_EMAILS</code>.</p>
    <textarea id="jwt" rows="4" cols="90" placeholder="Cole o token JWT aqui"></textarea>
    <button id="ping">Verificar /api/health</button>
    <pre id="out" style="white-space:pre-wrap;border:1px solid #ddd;padding:8px;"></pre>

    <!-- Garanta que esta p√°gina N√ÉO carregue /admin-dnd.js (ele tem HTML pr√≥prio). -->
  </section>

  <hr />

  <section>
    <h2>Lista b√°sica</h2>
    <button id="listCourses">Listar cursos</button>
    <button id="listCoursesCounts">Listar cursos + contagens</button>
    <button id="listTracks">Listar trilhas</button>
    <pre id="listOut" style="white-space:pre-wrap;border:1px solid #ddd;padding:8px;"></pre>
  </section>

  <hr />

  <!-- Analytics (curso) -->
  <section style="margin:16px 0;border:1px solid #ccc;padding:12px;border-radius:8px">
    <h2>Analytics (curso)</h2>
    <label>CourseId: <input id="anCourse" size="40" value="90db6f02-205f-43b6-a919-a7c01a559177"></label>
    <div style="margin:8px 0; display:flex; gap:8px; flex-wrap:wrap">
      <button id="anOverview">Overview</button>
      <button id="anTables">Tabelas (Time/Funnel/Quiz)</button>
      <button id="anLeaderboard">Leaderboard Tempo</button>
      <button id="anWeekly">Semanas</button>
      <button id="anExportTime">Export CSV (Time)</button>
      <button id="anRefresh">Refresh MVs</button>
    </div>
    <pre id="anOut" style="background:#111;color:#0f0;padding:8px;white-space:pre-wrap;max-height:260px;overflow:auto"></pre>
    <table id="anTable" border="1" style="width:100%;margin-top:8px;font-size:14px;">
      <thead></thead><tbody></tbody>
    </table>
  </section>

  <hr />

  <section>
    <h2>Criar aluno</h2>
    <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;max-width:900px">
      <input id="new-email" placeholder="email do aluno" style="min-width:320px" />
      <button id="createUser">Criar aluno (POST /api/admin/users)</button>
    </div>
    <pre id="userOut" style="white-space:pre-wrap;border:1px solid #ddd;padding:8px;"></pre>
  </section>

  <hr />

  <section>
    <h2>Entitlements (Conceder/Revogar acesso)</h2>
    <div style="display:grid;gap:6px;max-width:980px">
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <input id="grant-email" placeholder="email do aluno" style="flex:1" />
        <button id="grant-search">Buscar aluno</button>
      </div>
      <input id="grant-user" placeholder="userId (UUID do aluno)" />
      <div>
        <label><strong>Curso:</strong></label><br/>
        <select id="grant-course"></select>
        <button id="grant-load-courses">Recarregar cursos</button>
      </div>
      <div style="display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:8px">
        <div>
          <label>In√≠cio (opcional)</label><br/>
          <input id="grant-startsAt" type="datetime-local" />
        </div>
        <div>
          <label>Fim (opcional)</label><br/>
          <input id="grant-endsAt" type="datetime-local" />
        </div>
        <div>
          <label>Dura√ß√£o (dias, opcional)</label><br/>
          <input id="grant-durationDays" type="number" min="1" step="1" placeholder="ex.: 365" />
        </div>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin:6px 0">
        <button id="btnGrant">Conceder acesso (POST /api/admin/entitlements)</button>
        <button id="btnRevoke">Revogar acesso (POST /api/admin/entitlements)</button>
      </div>
    </div>
    <pre id="grantOut" style="white-space:pre-wrap;border:1px solid #ddd;padding:8px;"></pre>

    <!-- Infobox: como preencher metadata no Stripe para criar/revogar entitlements -->
    <details style="margin-top:12px;">
      <summary style="cursor:pointer;"><strong>Dica:</strong> metadata Stripe ‚Üí entitlements (clique para expandir)</summary>
      <div style="border:1px solid #eee;border-radius:8px;padding:12px;margin-top:8px;background:#fafafa;">
        <p style="margin:0 0 8px 0;">
          O webhook l√™ <em>metadata</em> nestas fontes (nesta ordem): <code>Price</code> ‚Üí <code>Product</code> ‚Üí <code>Checkout Session</code> / <code>Invoice</code> / <code>Subscription</code>.
          Use as chaves abaixo para conceder acesso ap√≥s pagamento:
        </p>
        <ul style="margin:0 0 8px 18px;">
          <li><code>course_id</code> (UUID) ‚Äî concede acesso a um curso espec√≠fico.</li>
          <li><code>track_id</code> (UUID) ‚Äî alternativa ao <code>course_id</code>, para trilhas.</li>
          <li><code>duration_days</code> (inteiro) ‚Äî janela em dias (ex.: <code>30</code>). Se ausente ‚Üí acesso vital√≠cio (<code>ends_at = NULL</code>).</li>
          <li><code>starts_at</code> (ISO 8601) ‚Äî opcional; in√≠cio customizado (ex.: <code>2025-01-10T09:00:00Z</code>).</li>
          <li><code>ends_at</code> (ISO 8601) ‚Äî opcional; fim customizado. Se for usado, ignora <code>duration_days</code>.</li>
        </ul>
        <p style="margin:0 0 8px 0;"><strong>Exemplo (Price ‚Üí Metadata):</strong></p>
<pre style="white-space:pre;border:1px solid #ddd;padding:8px;background:#fff;margin:0 0 8px 0;">
course_id: 90db6f02-205f-43b6-a919-a7c01a559177
duration_days: 30
</pre>
        <p style="margin:0 0 8px 0;"><strong>Exemplo (Checkout Session ‚Üí Metadata):</strong></p>
<pre style="white-space:pre;border:1px solid #ddd;padding:8px;background:#fff;margin:0 0 8px 0;">
track_id: 1b9c8e6a-3a02-4c7d-9f4f-5a9e1f2c3d4e
starts_at: 2025-02-01T12:00:00Z
ends_at: 2025-03-01T12:00:00Z
</pre>
        <ul style="margin:0 0 8px 18px;">
          <li>Reembolso (<code>charge.refunded/refund.updated</code>): webhook revoga somente entitlements com <code>source='stripe'</code> (admin grants n√£o s√£o afetados).</li>
          <li>Recompra/reativa√ß√£o: uma nova compra ajusta a janela (<code>ends_at</code>) para frente ou volta a vital√≠cio, conforme os metadados.</li>
        </ul>
        <p style="margin:0;">Dica: Prefira colocar metadata no <strong>Price</strong> (replicado entre produtos/itens) para reduzir erros.</p>
      </div>
    </details>
  </section>

  <hr />

  <section>
    <h2>Certificados (Admin)</h2>
    <div style="padding:8px;border:1px dashed #bbb;border-radius:8px;background:#fafafa;margin-bottom:8px;font-size:14px">
      <strong>Metadados / Op√ß√µes:</strong><br>
      ‚Ä¢ <code>fullName</code> (opcional): snapshot do nome a imprimir no PDF.<br>
      ‚Ä¢ <code>reissue=1</code> (opcional): reemite o certificado (atualiza arquivo/URL).<br>
      ‚Ä¢ <code>keepIssuedAt=1</code> (opcional, com reissue): preserva a data de emiss√£o original.<br>
      A emiss√£o grava <code>serial</code> (ULID) e <code>serial_hash</code> para verifica√ß√£o p√∫blica.
    </div>
    <div style="display:grid;gap:6px;max-width:900px">
      <input id="cert-user" placeholder="userId (UUID)" />
      <input id="cert-course" placeholder="courseId (UUID)" />
      <input id="cert-fullname" placeholder="Nome para imprimir (opcional)" />
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button id="btnIssueCert">Emitir (force=1)</button>
        <button id="btnReissueCert">Reemitir (force=1&reissue=1)</button>
        <button id="btnReissueKeepDate">Reemitir mantendo data (force=1&reissue=1&keepIssuedAt=1)</button>
      </div>
      <pre id="certOut" style="white-space:pre-wrap;border:1px solid #ddd;padding:8px;"></pre>
    </div>
  </section>

  <hr />

  <section>
    <h2>Novo curso</h2>
    <input id="c-slug" placeholder="slug" />
    <input id="c-title" placeholder="t√≠tulo" />
    <input id="c-summary" placeholder="resumo" />
    <input id="c-level" placeholder="level (beginner|...)" value="beginner" />
    <label><input type="checkbox" id="c-active" checked /> ativo</label>
    <button id="createCourse">Criar/Atualizar curso</button>
  </section>

  <section>
    <h2>Novo m√≥dulo</h2>
    <input id="m-course" placeholder="courseId" />
    <input id="m-title" placeholder="t√≠tulo do m√≥dulo" />
    <input id="m-order" type="number" value="0" />
    <button id="createModule">Criar m√≥dulo</button>
  </section>

  <section>
    <h2>Novo item</h2>
    <input id="i-module" placeholder="moduleId" />
    <select id="i-type">
      <option value="video">video</option>
      <option value="text">text</option>
      <option value="quiz">quiz</option>
    </select>
    <input id="i-order" type="number" value="0" />
    <input id="i-payload" placeholder='payload_ref (JSON) ex: {"mux_playback_id":"..."}' size="80" />
    <button id="createItem">Criar item</button>
  </section>

  <section>
    <h2>Quiz</h2>
    <div>
      <strong>Criar/atualizar quiz do m√≥dulo</strong><br/>
      <input id="q-module" placeholder="moduleId" />
      <input id="q-pass" type="number" value="70" />
      <button id="createQuiz">Criar/Atualizar quiz</button>
    </div>
    <div style="margin-top:8px;">
      <strong>Adicionar quest√£o</strong><br/>
      <input id="qq-quiz" placeholder="quizId" />
      <select id="qq-kind">
        <option value="single">single</option>
        <option value="multiple">multiple</option>
        <option value="truefalse">truefalse</option>
      </select>
      <input id="qq-body" placeholder='body JSON ex: {"prompt":"Pergunta?"}' size="60" />
      <input id="qq-choices" placeholder='choices JSON ex: [{"id":"A","text":"Op√ß√£o A"}]' size="60" />
      <input id="qq-answer" placeholder='answerKey JSON ex: ["A"] ou true/false' size="40" />
      <button id="addQuestion">Adicionar quest√£o</button>
    </div>
  </section>

  <hr />

  <section>
    <h2>Aluno (teste r√°pido)</h2>
    <p class="muted">Use o <em>mesmo JWT</em> do topo (ele precisa representar o aluno). Informe os IDs do curso/quiz.</p>
    <div style="display:grid;gap:6px;max-width:900px">
      <input id="me-course" placeholder="courseId (UUID)" />
      <input id="me-module" placeholder="moduleId (opcional, p/ simular leitura/v√≠deo)" />
      <input id="me-item"   placeholder="itemId (opcional, p/ simular leitura/v√≠deo)" />
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin:6px 0">
        <button id="btnMeModules">Ver progresso do aluno (GET /api/me/modules)</button>
        <button id="btnMeModulesSummary">Resumo de m√≥dulos (GET /api/me/modules-summary)</button>
        <button id="btnMeProgressSummary">Resumo geral (GET /api/me/progress-summary)</button>
        <button id="btnMeItems">Ver m√≥dulos + itens (GET /api/me/items)</button>
      </div>
      <div style="margin-top:8px">
        <strong>Enviar tentativa de quiz</strong><br/>
        <input id="me-quiz" placeholder="quizId (UUID)" />
        <textarea id="me-answers" rows="4" cols="90" placeholder='Ex.: [{"questionId":"Q1","choiceIds":["A","C"]},{"questionId":"Q2","choiceIds":["A"]}]'></textarea>
        <div class="muted" style="font-size:12px">
          Dica: o backend aceita <code>choiceIds</code>, <code>value</code> ou <code>choices</code> (sempre arrays).
          Este bot√£o tenta automaticamente os 3 formatos at√© obter sucesso (200).
        </div>
        <button id="btnSubmitQuiz">Enviar tentativa de quiz (POST /api/quizzes/:id/submit)</button>
      </div>
      <div style="margin-top:8px">
        <strong>Simula√ß√µes de tempo de uso</strong>
        <div class="muted" style="font-size:12px">
          Podem retornar 404 se os endpoints ainda n√£o estiverem ativos no deploy.
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin:6px 0">
          <button id="btnPageRead">Simular leitura (page-read 15s)</button>
          <button id="btnVideoBeat">Simular heartbeat v√≠deo (15s)</button>
        </div>
      </div>
    </div>
    <pre id="meOut" style="white-space:pre-wrap;border:1px solid #ddd;padding:8px;"></pre>
  </section>

  <section>
    <h2>Trilhas</h2>
    <div>
      <strong>Criar/atualizar trilha</strong><br/>
      <input id="t-slug" placeholder="slug" />
      <input id="t-title" placeholder="t√≠tulo" />
      <label><input type="checkbox" id="t-active" checked /> ativo</label>
      <button id="createTrack">Criar/Atualizar trilha</button>
    </div>
    <div style="margin-top:8px;">
      <strong>Adicionar curso √† trilha</strong><br/>
      <input id="tc-track" placeholder="trackId" />
      <input id="tc-course" placeholder="courseId" />
      <input id="tc-order" type="number" value="0" />
      <label><input type="checkbox" id="tc-required" checked /> required</label>
      <button id="addTrackCourse">Adicionar</button>
    </div>
  </section>

  <section>
    <h2>Pr√©-requisitos de curso</h2>
    <p>Define que o <em>courseId</em> exige o <em>requiredCourseId</em> (o aluno precisa concluir o requerido antes).</p>
    <input id="p-course" placeholder="courseId" />
    <input id="p-req" placeholder="requiredCourseId" />
    <button id="addPrereq">Criar pr√©-requisito</button>
  </section>

  <hr />

  <section>
    <h2>Visualizar trilha + pr√©-requisitos + status do aluno</h2>
    <p>Informe a <span class="code">trackId</span> e (opcional) o <span class="code">email</span> do aluno para ver bloqueios, progresso e conclus√£o.</p>
    <input id="g-track" placeholder="trackId" />
    <input id="g-email" placeholder="email do aluno (opcional)" />
    <button id="renderGraph">Renderizar</button>
    <div class="legend">
      <span class="pill ok">‚úì Conclu√≠do</span>
      <span class="pill warn">‚Üó Liberado (prereqs ok)</span>
      <span class="pill bad">‚õî Bloqueado (prereqs pend.)</span>
      <span class="pill">üé´ Entitlement</span>
      <span class="pill">üìä Progresso %</span>
    </div>
    <div id="graph" class="graph"></div>
    <pre id="graphRaw" style="white-space:pre-wrap;border:1px solid #ddd;padding:8px;"></pre>
  </section>

  <hr />

  <!-- Reordenar itens? Use a p√°gina dedicada: -->
  <p><a href="/admin-dnd.html">Abrir o Reordenador de Itens (drag-and-drop)</a></p>

  <script src="/admin.js"></script>
  <script>
    (function(){
      const $ = (s)=>document.querySelector(s);

      async function fetchJSON(url, init){
        // Se admin.js definiu 'api', preferir para manter header Authorization padronizado
        if (typeof window.api === 'function' && (!init || !init.headers)) {
          const { status, body } = await window.api(url, init);
          return { status, json: body };
        }
        const h = new Headers(init?.headers || {});
        if (!h.has("Authorization")) {
          const t = (document.getElementById("jwt")?.value || "").trim().replace(/^['"]+|['"]+$/g,"");
          if (t) h.set("Authorization", `Bearer ${t}`);
        }
        const r = await fetch(url, { ...init, headers: h });
        const txt = await r.text();
        try { return { status:r.status, json: JSON.parse(txt) }; } catch { return { status:r.status, json: txt }; }
      }

      // Helpers para CSV local (sem endpoint /export no servidor)
      function rowsToCSV(rows) {
        if (!rows?.length) return "";
        const cols = Object.keys(rows[0]);
        const head = cols.join(",");
        const body = rows.map(r => cols.map(c => {
          const v = r[c];
          if (v == null) return "";
          const s = String(v);
          return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
        }).join(",")).join("\n");
        return head + "\n" + body + "\n";
      }
      function downloadCSV(filename, csv) {
        const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
        const url = URL.createObjectURL(blob);
        try {
          const a = document.createElement('a');
          a.href = url;
          a.download = filename;
          document.body.appendChild(a);
          a.click();
          a.remove();
        } finally {
          URL.revokeObjectURL(url);
        }
      }

      $('#anOverview')?.addEventListener('click', async ()=>{
        const c=$('#anCourse').value.trim();
        const {status,json}=await fetchJSON(`/api/admin/analytics/overview?courseId=${c}`,{});
        $('#anOut').textContent = JSON.stringify({status,json},null,2);
        const row=json?.row||null;
        const thead=$('#anTable thead'); const tbody=$('#anTable tbody');
        thead.innerHTML = '<tr><th>time_total(s)</th><th>modules</th><th>started_sum</th><th>passed_sum</th><th>failed_sum</th></tr>';
        tbody.innerHTML = row ? `<tr>
          <td>${Number(row.time_spent_secs_total||0)}</td>
          <td>${Number(row.total_modules||0)}</td>
          <td>${Number(row.started_any_sum||0)}</td>
          <td>${Number(row.passed_sum||0)}</td>
          <td>${Number(row.failed_sum||0)}</td>
        </tr>` : '';
      });

      $('#anTables')?.addEventListener('click', async ()=>{
        const c=$('#anCourse').value.trim();
        const [time,funnel,quiz] = await Promise.all([
          fetchJSON(`/api/admin/analytics/time?courseId=${c}`,{}),
          fetchJSON(`/api/admin/analytics/funnel?courseId=${c}`,{}),
          fetchJSON(`/api/admin/analytics/quiz?courseId=${c}`,{}),
        ]);
        $('#anOut').textContent = JSON.stringify({time,funnel,quiz},null,2);

        const timeRows = (time.json?.rows||[]).map(r => ({
          ...r, time_spent_secs: Number(r.time_spent_secs || 0)
        }));
        const mapTime=new Map(timeRows.map(r=>[r.module_id, r.time_spent_secs]));
        const thead=$('#anTable thead'); const tbody=$('#anTable tbody');
        thead.innerHTML = '<tr><th>M√≥dulo</th><th>Ordem</th><th>Tempo(s)</th><th>Started</th><th>Passed</th><th>Failed</th></tr>';
        tbody.innerHTML = (funnel.json?.rows||[]).map(f=>{
          const secs = Number(mapTime.get(f.module_id) || 0);
          return `<tr>
            <td>${f.title}</td><td>${f.order}</td>
            <td>${secs}</td>
            <td>${Number(f.started_any||0)}</td>
            <td>${Number(f.passed_count||0)}</td>
            <td>${Number(f.failed_count||0)}</td>
          </tr>`;
        }).join('');
      });

      $('#anLeaderboard')?.addEventListener('click', async ()=>{
        const c=$('#anCourse').value.trim();
        const {status,json}=await fetchJSON(`/api/admin/analytics/time/users?courseId=${c}&limit=20`,{});
        $('#anOut').textContent = JSON.stringify({status,json},null,2);
        const thead=$('#anTable thead'); const tbody=$('#anTable tbody');
        thead.innerHTML = '<tr><th>Email</th><th>UserId</th><th>Tempo(s)</th></tr>';
        tbody.innerHTML = (json?.rows||[]).map(r=>`<tr>
          <td>${r.email||''}</td><td>${r.user_id}</td><td>${Number(r.time_spent_secs||0)}</td>
        </tr>`).join('');
      });

      $('#anWeekly')?.addEventListener('click', async ()=>{
        const c=$('#anCourse').value.trim();
        const {status,json}=await fetchJSON(`/api/admin/analytics/weekly?courseId=${c}&weeks=12`,{});
        if (status === 404) {
          $('#anOut').textContent = JSON.stringify({status, error: "weekly_endpoint_missing", hint: "Atualize o backend para expor /api/admin/analytics/weekly ou o bot√£o Semanas ficar√° indispon√≠vel."}, null, 2);
          const thead=$('#anTable thead'); const tbody=$('#anTable tbody');
          thead.innerHTML = ''; tbody.innerHTML = '';
          return;
        }
        $('#anOut').textContent = JSON.stringify({status,json},null,2);
        const thead=$('#anTable thead'); const tbody=$('#anTable tbody');
        thead.innerHTML = '<tr><th>Week Start</th><th>Users</th><th>Time(s)</th><th>Modules Started</th><th>Modules Passed</th></tr>';
        tbody.innerHTML = (json?.rows||[]).map(r=>`<tr>
          <td>${r.week_start}</td>
          <td>${Number(r.users_active||0)}</td>
          <td>${Number(r.time_spent_secs||0)}</td>
          <td>${Number(r.modules_started||0)}</td>
          <td>${Number(r.modules_passed||0)}</td>
        </tr>`).join('');
      });

      // Export CSV local (usa endpoints existentes e inclui Authorization)
      async function exportTimeCSVLocal(courseId) {
        const { status, json } = await fetchJSON(`/api/admin/analytics/time?courseId=${courseId}`, {});
        if (status !== 200) {
          $('#anOut').textContent = JSON.stringify({ status, json }, null, 2);
          return;
        }
        const rows = json?.rows || [];
        const csv = rowsToCSV(rows);
        downloadCSV(`time_${courseId}.csv`, csv);
      }
      $('#anExportTime')?.addEventListener('click', async ()=>{
        const c=$('#anCourse').value.trim();
        await exportTimeCSVLocal(c);
      });

      $('#anRefresh')?.addEventListener('click', async ()=>{
        const {status,json}=await fetchJSON(`/api/admin/analytics/refresh`,{method:'POST'});
        $('#anOut').textContent = JSON.stringify({status,json},null,2);
      });
    })();
  </script>
</body>
</html>

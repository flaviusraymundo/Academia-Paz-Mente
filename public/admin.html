<!doctype html>
<html lang="pt-BR">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Admin Lite</title>
<style>
  body { font-family: system-ui, Arial, sans-serif; line-height: 1.35; margin: 16px; }
  h1, h2 { margin: 8px 0; }
  input, textarea, select, button { margin: 4px 0; padding: 6px 8px; }
  pre { background:#fafafa }
  .graph { display: grid; gap: 12px; margin-top: 8px; }
  .level { display: flex; gap: 12px; align-items: flex-start; }
  .node { border:1px solid #ddd; border-radius: 10px; padding:10px 12px; min-width: 220px; box-shadow: 0 1px 2px rgba(0,0,0,.05); }
  .node .title { font-weight: 600; margin-bottom: 6px; }
  .pill { display:inline-block; border-radius:999px; padding:2px 8px; font-size:12px; margin-right:6px; border:1px solid #eee }
  .ok { background:#e8f9ee; border-color:#bfe8cd; }
  .warn { background:#fff7e0; border-color:#ffe28a; }
  .bad { background:#ffeaea; border-color:#ffc3c3; }
  .muted { color:#666 }
  .legend { display:flex; gap:8px; margin-top:6px; flex-wrap: wrap; }
  .legend .pill { border: none }
  .code { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; background:#f6f6f6; padding:2px 6px; border-radius:6px }
</style>
<body>
  <h1>Admin Lite</h1>

  <section>
    <h2>Auth</h2>
    <p>Pegue um JWT (DEV_FAKE): <code>/.netlify/functions/dev-jwt?email=seu@email</code>
       e cole abaixo. Seu e-mail deve estar em <code>ADMIN_EMAILS</code>.</p>
    <textarea id="jwt" rows="4" cols="90" placeholder="Cole o token JWT aqui"></textarea>
    <button id="ping">Verificar /api/health</button>
    <pre id="out" style="white-space:pre-wrap;border:1px solid #ddd;padding:8px;"></pre>

    <!-- Garanta que esta p√°gina N√ÉO carregue /admin-dnd.js (ele tem HTML pr√≥prio). -->
  </section>

  <hr />

  <section>
    <h2>Lista b√°sica</h2>
    <button id="listCourses">Listar cursos</button>
    <button id="listCoursesCounts">Listar cursos + contagens</button>
    <button id="listTracks">Listar trilhas</button>
    <pre id="listOut" style="white-space:pre-wrap;border:1px solid #ddd;padding:8px;"></pre>
  </section>

  <hr />

  <section>
    <h2>Novo curso</h2>
    <input id="c-slug" placeholder="slug" />
    <input id="c-title" placeholder="t√≠tulo" />
    <input id="c-summary" placeholder="resumo" />
    <input id="c-level" placeholder="level (beginner|...)" value="beginner" />
    <label><input type="checkbox" id="c-active" checked /> ativo</label>
    <button id="createCourse">Criar/Atualizar curso</button>
  </section>

  <section>
    <h2>Novo m√≥dulo</h2>
    <input id="m-course" placeholder="courseId" />
    <input id="m-title" placeholder="t√≠tulo do m√≥dulo" />
    <input id="m-order" type="number" value="0" />
    <button id="createModule">Criar m√≥dulo</button>
  </section>

  <section>
    <h2>Novo item</h2>
    <input id="i-module" placeholder="moduleId" />
    <select id="i-type">
      <option value="video">video</option>
      <option value="text">text</option>
      <option value="quiz">quiz</option>
    </select>
    <input id="i-order" type="number" value="0" />
    <input id="i-payload" placeholder='payload_ref (JSON) ex: {"mux_playback_id":"..."}' size="80" />
    <button id="createItem">Criar item</button>
  </section>

  <section>
    <h2>Quiz</h2>
    <div>
      <strong>Criar/atualizar quiz do m√≥dulo</strong><br/>
      <input id="q-module" placeholder="moduleId" />
      <input id="q-pass" type="number" value="70" />
      <button id="createQuiz">Criar/Atualizar quiz</button>
    </div>
    <div style="margin-top:8px;">
      <strong>Adicionar quest√£o</strong><br/>
      <input id="qq-quiz" placeholder="quizId" />
      <select id="qq-kind">
        <option value="single">single</option>
        <option value="multiple">multiple</option>
        <option value="truefalse">truefalse</option>
      </select>
      <input id="qq-body" placeholder='body JSON ex: {"prompt":"Pergunta?"}' size="60" />
      <input id="qq-choices" placeholder='choices JSON ex: [{"id":"A","text":"Op√ß√£o A"}]' size="60" />
      <input id="qq-answer" placeholder='answerKey JSON ex: ["A"] ou true/false' size="40" />
      <button id="addQuestion">Adicionar quest√£o</button>
    </div>
  </section>

  <hr />

  <section>
    <h2>Aluno (teste r√°pido)</h2>
    <p class="muted">Use o <em>mesmo JWT</em> do topo (ele precisa representar o aluno). Informe os IDs do curso/quiz.</p>
    <div style="display:grid;gap:6px;max-width:900px">
      <input id="me-course" placeholder="courseId (UUID)" />
      <input id="me-module" placeholder="moduleId (opcional, p/ simular leitura/v√≠deo)" />
      <input id="me-item"   placeholder="itemId (opcional, p/ simular leitura/v√≠deo)" />
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin:6px 0">
        <button id="btnMeModules">Ver progresso do aluno (GET /api/me/modules)</button>
        <button id="btnMeModulesSummary">Resumo de m√≥dulos (GET /api/me/modules-summary)</button>
        <button id="btnMeProgressSummary">Resumo geral (GET /api/me/progress-summary)</button>
        <button id="btnMeItems">Ver m√≥dulos + itens (GET /api/me/items)</button>
      </div>
      <div style="margin-top:8px">
        <strong>Enviar tentativa de quiz</strong><br/>
        <input id="me-quiz" placeholder="quizId (UUID)" />
        <textarea id="me-answers" rows="4" cols="90" placeholder='Ex.: [{"questionId":"Q1","choiceIds":["A","C"]},{"questionId":"Q2","choiceIds":["A"]}]'></textarea>
        <div class="muted" style="font-size:12px">
          Dica: o backend aceita <code>choiceIds</code>, <code>value</code> ou <code>choices</code> (sempre arrays).
          Este bot√£o tenta automaticamente os 3 formatos at√© obter sucesso (200).
        </div>
        <button id="btnSubmitQuiz">Enviar tentativa de quiz (POST /api/quizzes/:id/submit)</button>
      </div>
      <div style="margin-top:8px">
        <strong>Simula√ß√µes de tempo de uso</strong>
        <div class="muted" style="font-size:12px">
          Podem retornar 404 se os endpoints ainda n√£o estiverem ativos no deploy.
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin:6px 0">
          <button id="btnPageRead">Simular leitura (page-read 15s)</button>
          <button id="btnVideoBeat">Simular heartbeat v√≠deo (15s)</button>
        </div>
      </div>
    </div>
    <pre id="meOut" style="white-space:pre-wrap;border:1px solid #ddd;padding:8px;"></pre>
  </section>

  <section>
    <h2>Entitlements (Conceder/Revogar acesso)</h2>
    <div style="display:grid;gap:6px;max-width:900px">
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <input id="grant-email" placeholder="buscar aluno por e-mail" style="min-width:280px"/>
        <button id="grant-find-user">Buscar aluno</button>
        <span id="grant-found" style="font:12px/1.2 sans-serif;color:#555"></span>
      </div>
      <input id="grant-user" placeholder="userId (UUID do aluno)" />
      <div>
        <label><strong>Curso:</strong></label><br/>
        <select id="grant-course"></select>
        <button id="grant-load-courses">Recarregar cursos</button>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin:6px 0">
        <button id="btnGrant">Conceder acesso (POST /api/admin/entitlements)</button>
        <button id="btnRevoke">Revogar acesso (POST /api/admin/entitlements)</button>
      </div>
    </div>
    <pre id="grantOut" style="white-space:pre-wrap;border:1px solid #ddd;padding:8px;"></pre>
  </section>

  <section>
    <h2>Trilhas</h2>
    <div>
      <strong>Criar/atualizar trilha</strong><br/>
      <input id="t-slug" placeholder="slug" />
      <input id="t-title" placeholder="t√≠tulo" />
      <label><input type="checkbox" id="t-active" checked /> ativo</label>
      <button id="createTrack">Criar/Atualizar trilha</button>
    </div>
    <div style="margin-top:8px;">
      <strong>Adicionar curso √† trilha</strong><br/>
      <input id="tc-track" placeholder="trackId" />
      <input id="tc-course" placeholder="courseId" />
      <input id="tc-order" type="number" value="0" />
      <label><input type="checkbox" id="tc-required" checked /> required</label>
      <button id="addTrackCourse">Adicionar</button>
    </div>
  </section>

  <section>
    <h2>Pr√©-requisitos de curso</h2>
    <p>Define que o <em>courseId</em> exige o <em>requiredCourseId</em> (o aluno precisa concluir o requerido antes).</p>
    <input id="p-course" placeholder="courseId" />
    <input id="p-req" placeholder="requiredCourseId" />
    <button id="addPrereq">Criar pr√©-requisito</button>
  </section>

  <hr />

  <section>
    <h2>Visualizar trilha + pr√©-requisitos + status do aluno</h2>
    <p>Informe a <span class="code">trackId</span> e (opcional) o <span class="code">email</span> do aluno para ver bloqueios, progresso e conclus√£o.</p>
    <input id="g-track" placeholder="trackId" />
    <input id="g-email" placeholder="email do aluno (opcional)" />
    <button id="renderGraph">Renderizar</button>
    <div class="legend">
      <span class="pill ok">‚úì Conclu√≠do</span>
      <span class="pill warn">‚Üó Liberado (prereqs ok)</span>
      <span class="pill bad">‚õî Bloqueado (prereqs pend.)</span>
      <span class="pill">üé´ Entitlement</span>
      <span class="pill">üìä Progresso %</span>
    </div>
    <div id="graph" class="graph"></div>
    <pre id="graphRaw" style="white-space:pre-wrap;border:1px solid #ddd;padding:8px;"></pre>
  </section>

  <hr />

  <!-- Reordenar itens? Use a p√°gina dedicada: -->
  <p><a href="/admin-dnd.html">Abrir o Reordenador de Itens (drag-and-drop)</a></p>

  <script src="/admin.js"></script>
</body>
</html>
